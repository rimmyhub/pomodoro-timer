# Implementation Plan: macOS 메뉴바 Pomodoro Timer (v1.7)

## 0. 변경 이력
- 2026-02-14 v1.7: 캘린더 이벤트 시간은 실제 시작~실제 종료로 기록하고, 이벤트 메모에 순집중시간(일시정지 제외) 표기를 남기도록 정책 변경.
- 2026-02-14 v1.7: 통계 집계는 기존대로 순집중시간 기준을 유지함을 명시.
- 2026-02-14 v1.6: 집중 횟수 집계를 세션 종료일 기준 세션당 1회로 고정하고, 카테고리 전체 관리 경로를 메인 화면 카테고리 버튼 기준으로 명시.
- 2026-02-14 v1.6: 삭제 카테고리 필터를 categoryId 분리 + `이름 (삭제됨)` 라벨로 고정하고, 캘린더 기록도 일시정지 제외 순집중시간 기준으로 동기화.
- 2026-02-14 v1.5: 시작 전 입력은 `직접 정하기` 버튼 선택 시 노출로 고정하고, 텍스트 입력 우선 문구를 제거.
- 2026-02-14 v1.5: 1일 그래프 표시 범위를 선택 날짜 `00:00~24:00`로 고정하고, 삭제 카테고리 `(삭제됨)` 필터 표시 및 재생 중 카테고리 API 차단 검증을 테스트 계획에 반영.
- 2026-02-14 v1.4: PRD v1.4 기준으로 카테고리 변경 잠금 범위(선택/추가/수정/삭제) 및 적용 범위(메인/설정 전체 경로)를 구현 규칙에 반영.
- 2026-02-14 v1.4: 종료일 귀속과 1일 스택 시간대 분할(실제 발생 시각) 규칙을 통계 집계/테스트 항목에 반영.
- 2026-02-14 v1.4: FocusSession 스키마에 categoryId, categoryNameSnapshot 보존 정책을 명확화.

## 1. 범위 기준
이 문서는 `/Users/hyerim/Documents/dev/pomodoro-technique/PRD.md`(v1.7 Final Draft)를 구현하기 위한 개발 계획이다.

## 2. 개발 원칙
- 메뉴바 우선: 메인 플로우는 메뉴바 팝오버만으로 완료 가능해야 함
- 단순 상태 모델: 타이머 엔진은 단일 소스 오브 트루스(ViewModel/Store)로 관리
- 기록 우선 저장: 세션 완료 시 즉시 로컬 저장 후 부가 작업(캘린더, 통계) 처리
- 회귀 방지: 기능 단위로 수동 테스트 체크리스트 유지

## 3. 아키텍처 제안
- UI: `SwiftUI`
- 앱 진입: `MenuBarExtra`
- 상태 관리: `ObservableObject` 1개(또는 `@Observable` 기반 단일 Store)
- 도메인 모듈:
  - `TimerEngine`: 시작/일시정지/초기화/틱 처리
  - `DialMapper`: 원형 드래그 각도 <-> 분 값 변환
  - `CategoryService`: 카테고리 추가/선택/수정/삭제
  - `SessionStore`: 로컬 저장(설정 + 카테고리 + 세션 로그)
  - `StatsService`: 기간별 집계 + 카테고리 필터 집계 + 1일 스택 변환
  - `SoundService`: 알림음/백색소음 재생
  - `CalendarService`: EventKit 기반 Apple Calendar 연동

## 4. 단계별 구현 계획

### Phase 0. 프로젝트 베이스
- macOS 메뉴바 앱 골격 생성
- 최소 화면(원형, 시간 텍스트, 재생 버튼) 배치
- Done:
  - 메뉴바 아이콘 클릭 시 팝오버 표시
  - 앱 종료/재실행 가능

### Phase 1. 타이머 코어
- `TimerEngine` 구현
  - 상태: idle / running / paused
  - 값: configuredSeconds, remainingSeconds
  - 동작: start, pause, resume, reset
- 1초 Tick 기반 감소 및 UI 반영
- Done:
  - PRD AC #1, #2, #3, #4 충족

### Phase 2. 원형 다이얼 인터랙션
- 원형 드래그 제스처 구현
- 각도 -> 분(1~60) 매핑
- 결정사항 반영:
  - `12시=0`, 시계방향 증가
  - 재생 중 다이얼 입력 비허용
- Done:
  - 드래그 시 채움률/시간 텍스트 동기화
  - 60분 상한 보장

### Phase 3. 시작 전 질문/카테고리 플로우
- 시작 전 질문 UI 구현: `무엇에 집중하시겠어요?`
- 빠른 선택 3개 구현:
  - `공부하기`
  - `독서하기`
  - `직접 정하기`
- `직접 정하기` 선택 시 텍스트 입력 노출
- 입력 완료 시 카테고리 자동 저장
- 시작 전 UX 규칙: `직접 정하기` 버튼 선택 시에만 입력창 노출
- Done:
  - PRD AC #6, #7 충족

### Phase 4. 상단/하단 컨트롤 정리
- 좌상단: `초기화` 버튼 고정
- 좌상단: 초기화 옆 `카테고리` 버튼 고정
- 카테고리 버튼 클릭 시 등록 카테고리 `선택/수정/삭제` 진입 가능
- 카테고리 전체 관리는 메인 화면 `카테고리` 버튼 경로를 기준으로 제공
- 타이머 재생 중에는 카테고리 변경(선택/추가/수정/삭제) 액션 전체 비활성화
- 위 비활성화 정책은 메인 화면과 설정 화면을 포함한 모든 진입 경로에 동일 적용
- 우상단 설정 아이콘 고정
- 하단 중앙 재생/일시정지 버튼 아이콘 전환
- 초기화는 현재 세션에만 적용(기록 유지)
- Done:
  - UI 위치가 PRD 레이아웃과 일치
  - 카테고리 버튼에서 카테고리 관리 플로우 접근 가능

### Phase 5. 설정(테마/알림음/백색소음)
- 설정 화면 섹션화
- 테마 적용(앱 전체 tint + 그래프 포인트 색)
- 알림음 선택/재생
- 백색소음 ON/OFF + 트랙 선택
- 결정사항 반영:
  - 기본 사운드 = 없음
  - 프리셋(비/카페 등) 선택 제공
- Done:
  - 설정값 재실행 후 유지

### Phase 6. 학습 통계
- 세션 로그 스키마 확정
  - startedAt, endedAt, durationSec, categoryId, categoryNameSnapshot
- 기간 필터(1일/1주/1개월/6개월/1년)
- 카테고리 필터(All + category)
- 삭제된 카테고리도 `이름 (삭제됨)` 라벨로 필터 노출
- 삭제 카테고리 필터는 `categoryId` 기준으로 분리 집계
- 그래프 정책 반영:
  - 1일: 단일 막대 1개 + 24시간(1시간 단위) 스택
  - 1주 이상: 날짜 단위 막대
- 요약 수치:
  - 집중 횟수
  - 합계 시간
- 집계 규칙:
  - 로컬 시간대 기준
  - 일시정지 시간 제외
  - 집중 횟수는 세션 종료일 기준 세션당 1회
  - 자정 넘김 세션은 종료 시점 날짜 귀속
  - `1일` 24시간 스택은 실제 집중 발생 시각(시 단위)으로 분할
  - `1일` 그래프는 선택한 날짜 `00:00~24:00` 범위만 표시(범위 밖 제외)
- Done:
  - PRD AC #9, #10 충족

### Phase 7. Apple Calendar 연동
- EventKit 권한 요청/상태 처리
- 세션 완료 시 일정 생성(연동 ON일 때)
- 1차 정책: 기본 캘린더 1개에 기록
- 이벤트 시간: 실제 시작 시각~실제 종료 시각
- 이벤트 메모: 카테고리 + `순집중시간(일시정지 제외) 00:xx`
- Done:
  - PRD AC #11 충족

### Phase 8. 안정화/배포
- 장시간 실행 테스트(>= 60분)
- 앱 슬립/웨이크 복귀 처리
- Xcode Archive 기준 배포 검증
- Done:
  - 크래시 없이 동작

## 5. 데이터 모델 초안
- AppSettings
  - defaultMinutes(Int)
  - themeId(String)
  - notificationSoundId(String) // default: none
  - whiteNoiseEnabled(Bool)
  - whiteNoiseTrackId(String)
  - calendarEnabled(Bool)
  - selectedCalendarId(String?)
  - selectedCategoryId(String?)
- Category
  - id(UUID)
  - name(String)
  - createdAt(Date)
  - updatedAt(Date)
- FocusSession
  - id(UUID)
  - startedAt(Date)
  - endedAt(Date)
  - durationSec(Int)
  - categoryId(UUID)
  - categoryNameSnapshot(String)

## 6. 테스트 계획 (기능 단위)
- T1 타이머
  - 시작 -> 10초 후 정확히 10초 감소
  - 일시정지 -> 10초 대기 후 값 변화 없음
  - 초기화 -> configuredSeconds 복귀
- T2 다이얼
  - 1분/60분 경계값 정상 매핑
  - 재생 중 입력 무시 확인
- T3 시작 전 질문/카테고리
  - `무엇에 집중하시겠어요?` 문구 표시
  - `공부하기/독서하기/직접 정하기` 버튼 표시
  - 직접 정하기 입력 완료 시 카테고리 저장 확인
  - 저장된 카테고리 재선택 가능
  - 카테고리 수정/삭제 후 상태 일관성 유지
  - 카테고리 수정/삭제 후에도 과거 세션 통계 불변(스냅샷 유지)
  - 재생 중 메인/설정 모든 경로에서 카테고리 선택/추가/수정/삭제 API 차단 확인
- T4 설정
  - 테마/소리/백색소음 저장 후 재실행 유지
  - 기본 사운드 없음 확인
- T5 통계
  - 1일 단일 스택 막대(24스택) 집계 정확성
  - 로컬 시간대 기준 집계 정확성
  - 일시정지 구간 제외 집계 정확성
  - 집중 횟수가 종료일 기준 세션당 1회 집계되는지 검증
  - 자정 넘김 세션 종료일 귀속 검증
  - 1일 스택이 실제 집중 발생 시각(시 단위)으로 분할되는지 검증
  - 1일 그래프가 선택 날짜 `00:00~24:00` 범위만 표시하는지 검증
  - 카테고리 필터 적용 정확성
  - 삭제된 카테고리가 `이름 (삭제됨)` 라벨로 필터에 노출되는지 검증
  - 삭제 카테고리 필터가 `categoryId` 기준으로 분리되는지 검증
  - 각 기간 필터에서 집계 정확성 검증
- T6 캘린더
  - 권한 거부/허용 각각 UX 분기 확인
  - 기본 캘린더 이벤트가 실제 시작~실제 종료 시간으로 생성되는지 확인
  - 이벤트 메모에 카테고리와 `순집중시간(일시정지 제외) 00:xx`가 포함되는지 확인

## 7. 리스크 및 대응
- 리스크: 메뉴바 앱에서 타이머 정확도 저하(슬립/백그라운드)
  - 대응: 기준 시각(Date) 기반 보정 로직 사용
- 리스크: EventKit 권한/캘린더 선택 UX 복잡성
  - 대응: 1차는 기본 캘린더 저장, 2차에 고급 선택 제공
- 리스크: 카테고리 삭제 시 과거 세션 참조 무결성
  - 대응: 세션에 `categoryNameSnapshot` 저장
- 리스크: 1일 스택 막대 집계 기준 혼선
  - 대응: 24시간 고정 기준으로 테스트 데이터 검증

## 8. 작업 우선순위
1. Phase 0~2 (핵심 타이머 UX)
2. Phase 3 (시작 전 질문/카테고리)
3. Phase 4~5 (컨트롤/설정 완성)
4. Phase 6 (통계)
5. Phase 7 (캘린더)
6. Phase 8 (안정화)

## 9. 확정된 결정 사항
- 1일 통계 그래프: 단일 막대 1개 + 24시간(1시간 단위) 스택
- 시작 전 입력 UX: `직접 정하기` 버튼 선택 시 입력창 노출
- 시작 전 기본 빠른 선택: `공부하기`, `독서하기`, `직접 정하기`
- `직접 정하기` 입력 완료 시 카테고리 자동 추가
- 카테고리 전체 관리 경로: 메인 화면 `카테고리` 버튼
- 재생 중 다이얼 조작: 비허용
- 재생 중 카테고리 변경(선택/추가/수정/삭제): 비허용
- 재생 중 카테고리 변경 금지 정책은 메인/설정 모든 진입 경로에 동일 적용
- 카테고리 수정/삭제 후 과거 통계: 유지(세션 스냅샷 유지)
- 통계 집계 기준: 로컬 시간대, 일시정지 제외, 자정 넘김은 종료일 귀속
- 집중 횟수 집계 기준: 세션 종료일 기준, 세션당 1회
- 1일 스택 분할 기준: 실제 집중 발생 시각(시 단위)
- 1일 그래프 표시 범위: 선택 날짜 `00:00~24:00`(범위 밖 제외)
- 삭제 카테고리 필터 기준: `categoryId` 분리, 라벨 `이름 (삭제됨)`
- 캘린더 기록 기준: 이벤트 시간은 실제 시작~실제 종료, 메모에 순집중시간 표기
- 사운드 기본값: 없음
